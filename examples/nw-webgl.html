<html>
<head>
    <script id="2D-vert-shader" type="x-shader/x-vertex">
        attribute vec2 a_position;
        uniform vec2 u_resolution;
        uniform mat3 u_matrix;
        varying vec2 v_texCoord;
        void main(){
            gl_Position = vec4(u_matrix * vec3(a_position, 1), 1);
            v_texCoord = a_position;
        }
    </script>
    <script id="2D-frag-shader" type="x-shader/x-fragment">
        precision mediump float;
        uniform sampler2D u_image;
        varying vec2 v_texCoord;
        void main(){
            gl_FragColor = texture2D(u_image, v_texCoord);
        }
    </script>
</head>
<body>
    <canvas id="canvas" style="width:100%; height:100%"></canvas>
    <script>
        var CV = require("opencv");
        function loadImage() {
            CV.readImage("/files/car1.jpg", function (err, img) {
                render(img);
            });
        }
        function createTexture(image) {
            var data = new Uint8Array(image.packPixels("RGB"));
            var tex = gl.createTexture();
            gl.bindTexture(gl.TEXTURE_2D, tex);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
            gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGB, image.width(), image.height(),
                            0, gl.RGB, gl.UNSIGNED_BYTE, data);
            return tex;
        }
        function getShader(id) {
            var shaderScript, source, currentChild, shader;
            shaderScript = document.getElementById(id);
            if (!shaderScript) {
                return null;
            }
            source = "";
            currentChild = shaderScript.firstChild;
            while (currentChild) {
                if (currentChild.nodeType == currentChild.TEXT_NODE) {
                    source += currentChild.textContent;
                }
                currentChild = currentChild.nextSibling;
            }
            if (shaderScript.type == "x-shader/x-fragment") {
                shader = gl.createShader(gl.FRAGMENT_SHADER);
            }
            else if (shaderScript.type == "x-shader/x-vertex") {
                shader = gl.createShader(gl.VERTEX_SHADER);
            }
            else {
                return null;
            }
            gl.shaderSource(shader, source);
            gl.compileShader(shader);
            if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                alert("An error occurred compiling the shaders: " + gl.getShaderInfoLog(shader));
                return null;
            }
            return shader;
        }
        function render(image) {
            if (gl) {
                var vert = getShader("2D-vert-shader");
                var frag = getShader("2D-frag-shader");
                var program = gl.createProgram();
                gl.attachShader(program, vert);
                gl.attachShader(program, frag);
                gl.linkProgram(program);
                gl.useProgram(program);
                var posLoc = gl.getAttribLocation(program, "a_position");
                var u_imageLoc = gl.getUniformLocation(program, "u_image");
                var u_matrixLoc = gl.getUniformLocation(program, "u_matrix");
                var posBuffer = gl.createBuffer();
                gl.bindBuffer(gl.ARRAY_BUFFER, posBuffer);
                gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([
                    0.0, 0.0,
                    1.0, 0.0,
                    0.0, 1.0,
                    0.0, 1.0,
                    1.0, 0.0,
                    1.0, 1.0
                ]), gl.STATIC_DRAW);
                gl.enableVertexAttribArray(posLoc);
                gl.vertexAttribPointer(posLoc, 2, gl.FLOAT, false, 0, 0);
                var texture = createTexture(image);
                var dstX = 0;
                var dstY = 0;
                var dstWidth = gl.canvas.width;
                var dstHeight = gl.canvas.height;
                var clipX = dstX / gl.canvas.width * 2 - 1;
                var clipY = dstY / gl.canvas.height * -2 + 1;
                var clipWidth = dstWidth / gl.canvas.width * 2;
                var clipHeight = dstHeight / gl.canvas.height * -2;
                gl.uniformMatrix3fv(u_matrixLoc, false, [
                    clipWidth, 0, 0,
                    0, clipHeight, 0,
                    clipX, clipY, 1
                ]);
                gl.drawArrays(gl.TRIANGLES, 0, 6);
            }
        }
        var gl;
        gl = document.getElementById("canvas").getContext("webgl");
        loadImage();
    </script>
</body>
</html>
